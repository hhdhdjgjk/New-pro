<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ููุทุงุฑ</title>
<style>
  /* ุงูุฃููุงุท (CSS) */
  body {
    background: linear-gradient(to bottom, #f7f2e8, #eae3d2);
    font-family: 'Tahoma', sans-serif;
    text-align: center;
    padding: 20px;
    overflow-x: hidden;
    position: relative;
    min-height: 100vh;
  }

  h1 {
    color: #375233;
    font-size: 70px;
    margin-bottom: 30px;
    display: block;
  }

  .logo {
    display: none;
  }

  .top-boxes {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin: 25px 0;
  }

  .top-boxes div {
    width: 120px;
    height: 90px;
    line-height: 90px;
    border-radius: 14px;
    font-weight: bold;
    font-size: 36px;
  }

  .box-1 { background-color: #99ccff; }
  .box-2 { background-color: #ffe066; }
  .box-3 { background-color: #a8e6a3; }

  .grid {
    display: grid;
    grid-template-columns: repeat(8, 90px);
    grid-template-rows: repeat(8, 90px);
    gap: 12px;
    justify-content: center;
    position: relative; /* ูุฌุนููุง ููู ุชุฃุซูุฑ ุงูุณููุท */
    z-index: 10;
  }

  .cell {
    background-color: white;
    border: 2px solid #a0a087;
    border-radius: 14px;
    cursor: pointer;
    font-size: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .corner {
    pointer-events: none;
    background-color: #C2B280 !important;
    font-size: 48px;
    transform: rotate(180deg);
  }

  .buttons {
    margin-top: 50px;
    display: flex;
    justify-content: center;
    gap: 40px;
  }

  button {
    padding: 24px 40px;
    font-size: 26px;
    color: white;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #4f7044;
  }

  /* ุชูุณูู ุฒุฑ ุฅุนุงุฏุฉ ุงูุชุนููู */
  .buttons button {
    background-color: #C2B280;
  }

  .firework {
    position: absolute;
    width: 12px;
    height: 12px;
    background-color: gold;
    border-radius: 50%;
    animation: explode 1s ease-out forwards;
    z-index: 999;
  }

  @keyframes explode {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(3); opacity: 0; }
  }

  .congrats-text {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 90px;
    color: black;
    font-weight: bold;
    display: none;
    z-index: 1000;
    text-shadow: 1px 1px 3px #888;
  }

  /* ุฃููุงุท ุงูุฃุดูุงู ุงููุชุณุงูุทุฉ */
  .falling-shape {
    position: absolute;
    top: -50px; /* ุชุจุฏุฃ ูู ุฎุงุฑุฌ ุงูุดุงุดุฉ */
    width: 30px;
    height: 30px;
    background-color: transparent; /* ุงุฌุนู ุงูุฎูููุฉ ุดูุงูุฉ */
    border-radius: 50%; /* ุงูุชุฑุงุถู ูุฏุงุฆุฑุฉ */
    z-index: 1; /* ุฎูู ุงูุดุจูุฉ */
    opacity: 0.6; /* ุชูููู ุงูุดูุงููุฉ ููููุงู ูุฌุนููุง ุฃูู ุญุฏุฉ */
    animation: fall linear infinite;
  }

  .falling-star {
    clip-path: polygon(
      50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%,
      50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%
    );
    background-color: #a67c00;
  }

  .falling-circle {
    border-radius: 50%;
    background-color: #c19a6b;
  }

  @keyframes fall {
    0% { transform: translateY(-50px) translateX(0) rotate(0deg); opacity: 0.6; }
    100% { transform: translateY(110vh) translateX(calc(-10% + (var(--random-x) * 120%))) rotate(360deg); opacity: 0.6; }
  }


  /* ุชูุณููุงุช ูุงูุฐุฉ ุงูุชุนูููุงุช ุงูููุจุซูุฉ */
  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
  }

  .game-instructions-popup {
    background: white;
    padding: 30px 40px;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    text-align: center;
    position: relative;
    font-size: 20px;
    color: #333;
    max-height: 85vh;
    overflow-y: auto;
  }

  .game-instructions-popup h2 {
    color: #375233;
    font-size: 38px;
    margin-bottom: 25px;
  }

  .game-instructions-popup p {
    margin-bottom: 15px;
    line-height: 1.6;
    font-size: 22px;
    text-align: justify;
    text-align-last: right;
  }

  .game-instructions-popup ul {
    list-style: none;
    padding: 0;
    text-align: right;
    margin: 20px 0;
  }

  .game-instructions-popup ul li {
    margin-bottom: 10px;
    font-size: 22px;
  }

  .game-instructions-popup button {
    background-color: #375233;
    color: white;
    padding: 15px 30px;
    font-size: 22px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 20px;
    transition: background-color 0.3s ease;
  }

  .game-instructions-popup button:hover {
    background-color: #4f7044;
  }
  .advice-list {
    list-style-type: arabic-indic;
    padding-right: 25px;
    text-align: right;
  }
  .advice-list li {
    font-size: 22px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h1>ููุทุงุฑ</h1>

<div class="top-boxes">
  <div class="box-1">ู</div>
  <div class="box-2">ู</div>
  <div class="box-3">ู</div>
</div>

<div class="grid" id="grid"></div>

<div class="buttons">
  <button onclick="resetGrid()">ุฅุนุงุฏุฉ ุชุนููู</button>
</div>

<div id="congratsText" class="congrats-text"></div>

<audio id="clapSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_3b5bb8f3b4.mp3"></audio>

<div id="instructionsPopupOverlay" class="popup-overlay" style="display: none;">

  <div id="popup1" class="game-instructions-popup">
    <h2>ูุตูุญุฉ ุนูุดุงู ููุนุจ ููุณุชุงูุณโฆ ุจุณ ุจุฏูู ูุง ููุณู ุงูุฃูู ๐</h2>
    <ul class="advice-list">
      <li>ูก. โฐ "ุงููุนุจ ููุชุนุ ุจุณ ุฎููู ุจุนุฏ ุงูุตูุงุฉุ ุนุดุงู ูุง ุชุถูุน ุนููู ูุง ูุชุนุฉ ููุง ุฃุฌุฑ."</li>
      <li>ูข. ๐ "ุงููุนุจุฉ ุญููุฉุ ุจุณ ุงููุฑุขู ุฃุญููุ ุฎุฐ ูู ููุช ุจูู ุงูุฌููุงุช ูุงุฑุชูุญ ูุน ููุงู ุงููู."</li>
      <li>ูฃ. ๐ "ุฅุฐุง ุฌุงุก ููุช ุงูุตูุงุฉุ ูููู ุงููุนุจ ูููุณุจ ุฑุถุง ุฑุจ ุงูุนุงูููู."</li>
      <li>ูค. โ "ููุนุจ ููุถุญูุ ููู ูุง ูุฎูู ุงููุนุจ ูููููุง ุนู ุทุงุนุฉ ุงููู."</li>
      <li>ูฅ. ๐ "ุงููุนุจ ูุง ูููุน ุฅูู ุชุฐุงูุฑุ ูุธูู ููุชู ูุฎูู ุงููุนุจ ููุงูุฃุฉ ุจุนุฏ ุงูุฅูุฌุงุฒ."</li>
      <li>ูฆ. ๐ฏ "ุงููุนุจุฉ ุฌุฒุก ูู ููููุงุ ูู ูู ููููุงโฆ ูุง ุชูุณู ุฃูุฏุงูู ูุทููุญุงุชู."</li>
      <li>ูง. โ "ููุช ุงููุฐุงูุฑุฉ ุบุงููุ ูุง ุชุฎููู ูุถูุน ุนูู ุญุณุงุจ ุฌูู ูููู ุชูุนุจู ุจุฃู ููุช."</li>
    </ul>
    <p>ุชุฐูุฑ <strong>"ุฅุฐุง ูุนุจุช ูุงูุช ูุญุงูุธ ุนูู ุตูุงุชู ูุงุฐูุงุฑู ููุฑุงุกุฉ ุงููุฑุงู ูุฎูุตุช ุงููุฐุงูุฑู ูุงูุงุดุบุงู ุงูู ุนููู โฆ ุฃูุช ูุณุจุช ุงูุฏููุง ูุงูุขุฎุฑุฉ ุจุฅุฐู ุงููู"</strong></p>
    <button onclick="showNextPopup(2)">ุงูุชุงูู</button>
  </div>

  <div id="popup2" class="game-instructions-popup" style="display: none;">
    <h2>ุชุนูููุงุช ูุนุจุฉ ููุทุงุฑ</h2>

    <h3>โ ููุฑุฉ ุงููุนุจุฉ:</h3>
    <p>ูุนุจุฉ "ููุทุงุฑ" ูู ุชุญุฏูู ุจูู ูุงุนุจูู (2-3) ุฃู ูุฑูููู (2-3)ุ ุงููุฏู ูููุง ูู ุชูููู ููุทุงุฑูู ุฏุงุฎู ุดุจูุฉ ุงููุฑุจุนุงุช. ูู ููุทุงุฑ ูุชููู ูู ูค ูุฑุจุนุงุช ูุชุฌุงูุฑุฉ ูู ููุณ ุงูููู.</p>

    <h3>โ ุดุฑูุท ุงูููุฒ:</h3>
    <ul>
      <li>1- ูููุฒ ุงููุงุนุจ ุฃู ุงููุฑูู ุงูุฐู ูุชููู ุฃูููุง ูู ุชูููู ููุทุงุฑูู (ูู ููููุง ููููู ูู ูค ูุฑุจุนุงุช ูุชุตูุฉ ูู ููุณ ุงูููู).</li>
      <li>2- ุงูููุทุงุฑุงู ูุง ูุฌูุฒ ุฃู ูุดุชุฑูุง ูู ุฃูุซุฑ ูู ูุฑุจุน ูุงุญุฏ ููุท ูู ุงููุฑุจุนุงุช ุงูุชู ุชู ุชูููููุง.</li>
      <li>3- ููุณูุญ ุฃู ูุจุฏุฃ ุฃุญุฏ ุงูููุทุงุฑูู ุฃู ููุชูู ูู ุฃุญุฏ ุงูุฒูุงูุง ุงูุฃุฑุจุน ุงูุซุงุจุชุฉุ ูุชูุนุชุจุฑ ูุฐู ุงูุฒูุงูุง ููุทุฉ ูุญุงูุฏุฉ ูููู ููุฌููุน ุงุณุชุฎุฏุงููุง ุจุญุฑูุฉ ูู ุชูููู ุงูููุงุทูุฑ ุฏูู ุฃู ูุคุซุฑ ุฐูู ุนูู ุดุฑุท ุงูุชุฏุงุฎู.</li>
    </ul>
    <h3>ุชูุงุตูู ุงูููุทุงุฑ:</h3>
    <p>ูููู ุฃู ูููู ุงูููุทุงุฑ ูู ุดูู ุฎุท ูุณุชููู (ุฃููู ุฃู ุฑุฃุณู ุฃู ูุทุฑู) ูู ูค ูุฑุจุนุงุช ูู ููุณ ุงูููู.</p>

    <h3>โ ุงูุฒูุงูุง ุงูุซุงุจุชุฉ:</h3>
    <p>ุงูุฒูุงูุง ุงูุฃุฑุจุน ูุง ูููู ุชุบููุฑ ููููุง ูููู ูููู ุงุณุชุฎุฏุงููุง ูููุทุฉ ุจุฏุงูุฉ ุฃู ููุงูุฉ ูุฃู ููุทุงุฑ ูู ุฃู ูุฑูู. ูุชูุญุชุณุจ ุถูู "ุนุฏุฏ" ุงููุฑุจุนุงุช ุงูุฃุฑุจุนุฉ.</p>

    <h3>โ ุทุฑููุฉ ุงููุนุจ:</h3>
    <p>ุนูุฏ ุงูููุฑ ุนูู ูุฑุจุนุ ูุชุบููุฑ ูููู ุจุงูุชุณูุณู: ุฃุจูุถ โ ุฃุฒุฑู ูุงุชุญ โ ุฃุตูุฑ ูุงุชุญ โ ุฃุฎุถุฑ ูุงุชุญ โ ุฃุจูุถ.</p>
    <p>ูู ูุงุนุจ ุฃู ูุฑูู ูุฎุชุงุฑ ููููุง ููุนูู ุนูู ุจูุงุก ุงูููุทุงุฑุงุช ุญุณุจ ุฏูุฑู. ูู ูู ุฏูุฑ ูุชู ุชูุฌูู ุณุคุงู ูููุฑูู ุจุงุณุชุฎุฏุงู ููู ุงูุฃุณุฆูุฉ ูุนูุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูููู ุงููุฑูู ุจุชูููู ูุฑุจุน ุจูููู ูููุฐุง ูู ูุฑูู ุนูุฏ ุฏูุฑู ูููู ุจููุณ ุงูุฎุทูุงุช ูุงููุฏู ุจูุงุก ููุทุงุฑูู ูู ูค ูุฑุจุนุงุช ุจููู ุงููุฑูู.</p>

    <h3>โ ุฃุฒุฑุงุฑ ุงูุชุญูู:</h3>
    <p><strong>ุฒุฑ ุฅุนุงุฏุฉ ุชุนููู:</strong> ูุนูุฏ ุงูุดุจูุฉ ุฅูู ุญุงูุชูุง ุงูุฃุตููุฉ (ูู ุงููุฑุจุนุงุช ุจูุถุงุก ูุง ุนุฏุง ุงูุฒูุงูุง).</p>

    <button onclick="closeInstructionsPopup()">ุงุจุฏุฃ ุงููุนุจ</button>
  </div>

</div>

<script>
  const colors = ["white", "#99ccff", "#ffe066", "#a8e6a3"];
  const grid = document.getElementById("grid");
  const rows = 8;
  const cols = 8;

  // ุชุนุฑูู ุงูุฒูุงูุง ุงูุฃุฑุจุน
  const cornerCellIndices = [0, cols - 1, rows * cols - cols, rows * cols - 1];

  const gridData = new Array(rows * cols).fill(0); // 0 for white, 1 for blue, 2 for yellow, 3 for green
  let currentPopupIndex = 1;

  function indexToRC(index) {
    return { row: Math.floor(index / cols), col: index % cols };
  }

  function rcToIndex(r, c) {
    return r * cols + c;
  }

  // ุฅูุดุงุก ุฎูุงูุง ุงูุดุจูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
  for (let i = 0; i < rows * cols; i++) {
    const cell = document.createElement("div");
    cell.className = "cell";

    if (cornerCellIndices.includes(i)) {
      cell.classList.add("corner");
      cell.textContent = "ร"; // ูููู ุชุบููุฑ ูุฐุง ุงูุญุฑู ูุฑูุฒ ุขุฎุฑ ููุซู ุงูุฒุงููุฉ
    } else {
      cell.dataset.index = i; // ุชุฎุฒูู index ุงูุฎููุฉ
      cell.onclick = (event) => {
        const cellIndex = parseInt(event.target.dataset.index);
        let currentIndex = gridData[cellIndex]; // ุงุณุชุฎุฏุงู cellIndex ูููุตูู ููุนูุตุฑ ุงูุตุญูุญ
        let nextIndex = (currentIndex + 1) % colors.length;
        gridData[cellIndex] = nextIndex; // ุชุญุฏูุซ ุงูุนูุตุฑ ุงูุตุญูุญ ูู gridData
        event.target.style.backgroundColor = colors[nextIndex]; // ุชุทุจูู ุงูููู ุงูุตุญูุญ
        checkForCongrats();
      };
    }
    grid.appendChild(cell); // ูุฐุง ุงูุณุทุฑ ูู ุงูุฐู ูุถูู ุงููุฑุจุน ุฅูู ุงูุดุจูุฉ
  }

  // ุฏุงูุฉ ุฌุฏูุฏุฉ ููุชุญูู ูู ุงูุตู ุฃู ุงูุนููุฏ ุฃู ุงููุทุฑ ุงููุงูู ูู ุงูุฒุงููุฉ ุฅูู ุงูุฒุงููุฉ
  function isFullLineCornerToCorner(targetColorIndex) {
      // ุงูุชุญูู ูู ุฌููุน ุงูุตููู ุงูุฃูููุฉ
      for (let r = 0; r < rows; r++) {
          let allCellsMatch = true;
          for (let c = 0; c < cols; c++) {
              const idx = rcToIndex(r, c);
              if (!cornerCellIndices.includes(idx)) { // ุฅุฐุง ูู ุชูู ุฎููุฉ ุฒุงููุฉ
                  if (gridData[idx] !== targetColorIndex) { // ุงุณุชุฎุฏู gridData[idx]
                      allCellsMatch = false;
                      break;
                  }
              }
          }
          if (allCellsMatch) {
              return true; // ุชู ุงูุนุซูุฑ ุนูู ุตู ุฃููู ูุงูู
          }
      }

      // ุงูุชุญูู ูู ุฌููุน ุงูุฃุนูุฏุฉ ุงูุนููุฏูุฉ
      for (let c = 0; c < cols; c++) {
          let allCellsMatch = true;
          for (let r = 0; r < rows; r++) {
              const idx = rcToIndex(r, c);
              if (!cornerCellIndices.includes(idx)) { // ุฅุฐุง ูู ุชูู ุฎููุฉ ุฒุงููุฉ
                  if (gridData[idx] !== targetColorIndex) { // ุงุณุชุฎุฏู gridData[idx]
                      allCellsMatch = false;
                      break;
                  }
              }
          }
          if (allCellsMatch) {
              return true; // ุชู ุงูุนุซูุฑ ุนูู ุนููุฏ ุนููุฏู ูุงูู
          }
      }

      // ุงูุชุญูู ูู ุงููุทุฑ ุงูุฑุฆูุณู (\)
      let allCellsMatchMainDiagonal = true;
      for (let i = 0; i < rows; i++) { // ุจูุง ุฃู ุงูุดุจูุฉ 8x8ุ rows == cols
          const idx = rcToIndex(i, i);
          if (!cornerCellIndices.includes(idx)) {
              if (gridData[idx] !== targetColorIndex) { // ุงุณุชุฎุฏู gridData[idx]
                  allCellsMatchMainDiagonal = false;
                  break;
              }
          }
      }
      if (allCellsMatchMainDiagonal) {
          return true;
      }

      // ุงูุชุญูู ูู ุงููุทุฑ ุงูุซุงููู (/)
      let allCellsMatchAntiDiagonal = true;
      for (let i = 0; i < rows; i++) {
          const idx = rcToIndex(i, cols - 1 - i);
          if (!cornerCellIndices.includes(idx)) {
              if (gridData[idx] !== targetColorIndex) { // ุงุณุชุฎุฏู gridData[idx]
                  allCellsMatchAntiDiagonal = false;
                  break;
              }
          }
      }
      if (allCellsMatchAntiDiagonal) {
          return true;
      }

      return false; // ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ุฎุท ูุงูู ูู ุงูุฒุงููุฉ ููุฒุงููุฉ
  }


  function checkForCongrats() {
    let allTrainsFound = {
      1: [], // ููููุทุงุฑุงุช ุงูุฒุฑูุงุก
      2: [], // ููููุทุงุฑุงุช ุงูุตูุฑุงุก
      3: []  // ููููุทุงุฑุงุช ุงูุฎุถุฑุงุก
    };

    // Helper function to get cell color, treating corners as "wildcards"
    function getEffectiveCellColor(idx, targetColorIndex) {
      if (cornerCellIndices.includes(idx)) {
        return targetColorIndex; // Corner acts as the target color if it's part of a potential train
      }
      return gridData[idx]; // ุงุณุชุฎุฏู gridData[idx]
    }

    // Helper function to check for a 4-square train
    // ูุฐุง ุงูุฌุฒุก ุณููุชุดู ุงูููุงุทูุฑ ุงูุชู ุชุชุถูู 3 ุฎูุงูุง + ุฒุงููุฉ (ูุฃู ุงูุฒุงููุฉ ุชูุนุชุจุฑ ุจููู ุงููุฑูู)
    function checkLine(r, c, dr, dc, targetColorIndex) {
        const line = []; // Stores all 4 cell indices (including corners)
        const nonCornerCells = []; // Stores only non-corner cells in this train

        for (let i = 0; i < 4; i++) {
            const currR = r + i * dr;
            const currC = c + i * dc;
            if (currR < 0 || currR >= rows || currC < 0 || currC >= cols) {
                return null;
            }
            const idx = rcToIndex(currR, currC);

            // Check if the cell (or effective corner) matches the target color
            if (getEffectiveCellColor(idx, targetColorIndex) !== targetColorIndex) {
                return null;
            }
            line.push(idx); // Add to the full line
            if (!cornerCellIndices.includes(idx)) {
                nonCornerCells.push(idx); // Only add non-corner cells here
            }
        }

        // Ensure no 5th consecutive cell of the same color (to ensure it's exactly 4)
        const nextR = r + 4 * dr;
        const nextC = c + 4 * dc;
        if (nextR >= 0 && nextR < rows && nextC >= 0 && nextC < cols) {
            const nextIdx = rcToIndex(nextR, nextC);
            if (getEffectiveCellColor(nextIdx, targetColorIndex) === targetColorIndex) {
                return null; // A 5th cell means this isn't a 4-cell train
            }
        }
        return { line: new Set(line), nonCornerCells: new Set(nonCornerCells) };
    }

    // Collect all possible trains for each color
    for (let targetColorIndex = 1; targetColorIndex <= 3; targetColorIndex++) {
        // Horizontal
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c <= cols - 4; c++) {
                const train = checkLine(r, c, 0, 1, targetColorIndex);
                if (train) allTrainsFound[targetColorIndex].push(train);
            }
        }

        // Vertical
        for (let c = 0; c < cols; c++) {
            for (let r = 0; r <= rows - 4; r++) {
                const train = checkLine(r, c, 1, 0, targetColorIndex);
                if (train) allTrainsFound[targetColorIndex].push(train);
            }
        }

        // Diagonal \
        for (let r = 0; r <= rows - 4; r++) {
            for (let c = 0; c <= cols - 4; c++) {
                const train = checkLine(r, c, 1, 1, targetColorIndex);
                if (train) allTrainsFound[targetColorIndex].push(train);
            }
            }

        // Diagonal /
        for (let r = 0; r <= rows - 4; r++) {
            for (let c = 3; c < cols; c++) {
                const train = checkLine(r, c, 1, -1, targetColorIndex);
                if (train) allTrainsFound[targetColorIndex].push(train);
            }
        }
    }

    // Calculate final valid trains count for each color
    let finalTrainsCountColor1 = 0;
    let finalTrainsCountColor2 = 0;
    let finalTrainsCountColor3 = 0;

    for (let targetColorIndex = 1; targetColorIndex <= 3; targetColorIndex++) {
        let currentWinningTrainsCount = 0;

        // ุงูุฃููููุฉ ุงูุฃููู: ุงูุชุญูู ูู ุญุงูุฉ ุงูุตู ุฃู ุงูุนููุฏ ุฃู ุงููุทุฑ ุงููุงูู ูู ุงูุฒุงููุฉ ุฅูู ุงูุฒุงููุฉ
        if (isFullLineCornerToCorner(targetColorIndex)) {
            currentWinningTrainsCount = 2; // ุฅุฐุง ูุงู ุฎุท ูุงููุ ูุญุตู ุนูู ููุทุงุฑูู ูุจุงุดุฑุฉ
        } else {
            // ุฅุฐุง ูู ููู ุฎุท ูุงููุ ูุนูุฏ ูููุทู ุงูุจุญุซ ุนู ุฒูุฌูู ูุน ุชุฏุงุฎู ุฎููุฉ ูุงุญุฏุฉ
            const trainsOfCurrentColor = allTrainsFound[targetColorIndex];
            const uniqueTrains = [];
            const uniqueTrainLineStrings = new Set();
            for (const train of trainsOfCurrentColor) {
                // ุงุณุชุฎุฏุงู ุฌููุน ุงูุฎูุงูุง ูู ุงูุฎุท (ุจูุง ูู ุฐูู ุงูุฒูุงูุง) ูุชุนุฑูู ุงูููุทุงุฑ ุจุดูู ูุฑูุฏ
                const trainString = Array.from(train.line).sort((a, b) => a - b).join(',');
                if (!uniqueTrainLineStrings.has(trainString)) {
                    uniqueTrains.push(train);
                    uniqueTrainLineStrings.add(trainString);
                }
            }

            if (uniqueTrains.length >= 2) {
                let foundValidPair = false;
                for (let i = 0; i < uniqueTrains.length; i++) {
                    for (let j = i + 1; j < uniqueTrains.length; j++) {
                        const trainA = uniqueTrains[i];
                        const trainB = uniqueTrains[j];

                        // ุญุณุงุจ ุงูุฎูุงูุง ุบูุฑ ุงูุฒุงููุฉ ุงููุดุชุฑูุฉ
                        let commonNonCornerCellsCount = 0;
                        for (const cellIdx of trainA.nonCornerCells) {
                            if (trainB.nonCornerCells.has(cellIdx)) {
                                commonNonCornerCellsCount++;
                            }
                        }

                        // ุงูุดุฑุท: ูุง ูุฌูุฒ ุฃู ูุดุชุฑูุง ูู ุฃูุซุฑ ูู ูุฑุจุน ูุงุญุฏ ููุท ูู ุงููุฑุจุนุงุช ุงูููููุฉ (ุบูุฑ ุงูุฒูุงูุง)
                        if (commonNonCornerCellsCount <= 1) {
                            foundValidPair = true;
                            break;
                        }
                    }
                    if (foundValidPair) break;
                }
                if (foundValidPair) {
                    currentWinningTrainsCount = 2;
                } else if (uniqueTrains.length > 0) {
                    currentWinningTrainsCount = 1; // ุฅุฐุง ูุฌุฏ ููุทุงุฑ ูุงุญุฏ ุนูู ุงูุฃูู ููู ูุฌุฏ ุฒูุฌ
                } else {
                    currentWinningTrainsCount = 0;
                }
            } else {
                currentWinningTrainsCount = uniqueTrains.length; // ุนุฏุฏ ุงูููุงุทูุฑ ุงูููุชุดูุฉ (0 ุฃู 1)
            }
        }

        if (targetColorIndex === 1) finalTrainsCountColor1 = currentWinningTrainsCount;
        else if (targetColorIndex === 2) finalTrainsCountColor2 = currentWinningTrainsCount;
        else finalTrainsCountColor3 = currentWinningTrainsCount;
    }

    document.querySelector('.box-1').textContent = finalTrainsCountColor1.toString().padStart(1, 'ู');
    document.querySelector('.box-2').textContent = finalTrainsCountColor2.toString().padStart(1, 'ู');
    document.querySelector('.box-3').textContent = finalTrainsCountColor3.toString().padStart(1, 'ู');

    let winnerMessage = "";
    if (finalTrainsCountColor1 >= 2) {
      winnerMessage = "ูุจุฑูู ูููุฑูู ุงูุฃุฒุฑู ๐";
    } else if (finalTrainsCountColor2 >= 2) {
      winnerMessage = "ูุจุฑูู ูููุฑูู ุงูุฃุตูุฑ ๐";
    } else if (finalTrainsCountColor3 >= 2) {
      winnerMessage = "ูุจุฑูู ูููุฑูู ุงูุฃุฎุถุฑ ๐";
    }

    if (winnerMessage !== "") {
      showCongrats(winnerMessage);
    }
  }

  function resetGrid() {
    const cells = document.querySelectorAll(".cell");

    for(let i = 0; i < gridData.length; i++) {
      gridData[i] = 0; // ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงูููู ูู ุงูุจูุงูุงุช
      const cellElement = grid.children[i]; // ุงููุตูู ููุนูุตุฑ ุงูุตุญูุญ
      if (!cornerCellIndices.includes(i)) {
        cellElement.style.backgroundColor = colors[0]; // ุฅุนุงุฏุฉ ุงูููู ุงูุฃุจูุถ
      }
    }

    document.getElementById("congratsText").style.display = "none";
    document.querySelector('.box-1').textContent = 'ู';
    document.querySelector('.box-2').textContent = 'ู';
    document.querySelector('.box-3').textContent = 'ู';
  }

  function showCongrats(message) {
    const sound = document.getElementById("clapSound");
    const text = document.getElementById("congratsText");
    sound.currentTime = 0;
    sound.play();

    text.textContent = message;
    text.style.display = "block";
    setTimeout(() => { text.style.display = "none"; }, 2000);

    for (let i = 0; i < 50; i++) {
      const firework = document.createElement("div");
      firework.className = "firework";
      firework.style.top = Math.random() * window.innerHeight + "px";
      firework.style.left = Math.random() * window.innerWidth + "px";
      document.body.appendChild(firework);
      setTimeout(() => firework.remove(), 1000);
    }
  }

  function showNextPopup(nextIndex) {
    document.getElementById('popup' + currentPopupIndex).style.display = 'none';

    if (nextIndex <= 2) {
      document.getElementById('popup' + nextIndex).style.display = 'block';
      currentPopupIndex = nextIndex;
    } else {
      closeInstructionsPopup();
    }
  }

  function closeInstructionsPopup() {
    document.getElementById("instructionsPopupOverlay").style.display = "none";
  }

  // ุฏุงูุฉ ูุฅูุดุงุก ุดูู ูุชุณุงูุท
  function createFallingShape() {
    const shapes = [
      { className: 'falling-star' },
      { className: 'falling-circle' }
    ];
    // ุงุฎุชูุงุฑ ุดูู ุนุดูุงุฆู ูู ุงููุตูููุฉ
    const randomShape = shapes[Math.floor(Math.random() * shapes.length)];

    const shapeDiv = document.createElement('div');
    shapeDiv.classList.add('falling-shape', randomShape.className);
    shapeDiv.style.left = Math.random() * 100 + 'vw'; // ูููุน ุนุดูุงุฆู ุฃููู
    shapeDiv.style.setProperty('--random-x', Math.random()); // ูุชุบูุฑ CSS ูุญุฑูุฉ ุฃูููุฉ ุนุดูุงุฆูุฉ
    shapeDiv.style.animationDuration = (Math.random() * 12 + 12) + 's'; // ุณุฑุนุฉ ุฃุจุทุฃ (12-24 ุซูุงูู)
    shapeDiv.style.animationDelay = (Math.random() * -20) + 's'; // ุชุฃุฎูุฑ ุนุดูุงุฆู ุฃูุจุฑ ูุชุจุฏู ูุฃููุง ูุณุชูุฑุฉ
    shapeDiv.style.opacity = 0.5 + Math.random() * 0.3; // ุชูุงูุช ูู ุงูุดูุงููุฉ

    // ุชุญุฏูุฏ ููู ุงูุฎูููุฉ
    if (randomShape.className === 'falling-circle') {
      shapeDiv.style.backgroundColor = '#c19a6b';
    } else if (randomShape.className === 'falling-star') {
      shapeDiv.style.backgroundColor = '#a67c00';
    }

    document.body.appendChild(shapeDiv);

    // ุฅุนุงุฏุฉ ุถุจุท ููุถุน ุงูุดูู ุนูุฏ ุงูุชูุงุก ุงูุฃูููุดู ููุนุทู ุฅุญุณุงุณุงู ุจุงูุณููุท ุงููุณุชูุฑ
    shapeDiv.addEventListener('animationiteration', () => {
        shapeDiv.style.left = Math.random() * 100 + 'vw';
        shapeDiv.style.setProperty('--random-x', Math.random());
        shapeDiv.style.animationDuration = (Math.random() * 12 + 12) + 's';
        shapeDiv.style.opacity = 0.5 + Math.random() * 0.3;
    });
  }

  // ุฅูุดุงุก ุงูุฃุดูุงู ุงููุชุณุงูุทุฉ ุจุดูู ูุณุชูุฑ
  function startFallingShapes() {
    const numberOfShapes = 25; // ุนุฏุฏ ุฃูู ูุฌุนููุง ููุณุช ูุซูุฑุฉ
    for (let i = 0; i < numberOfShapes; i++) {
      createFallingShape();
    }
  }


  window.onload = () => {
    document.getElementById("instructionsPopupOverlay").style.display = "flex";
    document.getElementById('popup1').style.display = 'block';
    currentPopupIndex = 1;

    document.querySelector('.box-1').textContent = 'ู';
    document.querySelector('.box-2').textContent = 'ู';
    document.querySelector('.box-3').textContent = 'ู';

    startFallingShapes(); // ุงุจุฏุฃ ุชุฃุซูุฑ ุณููุท ุงูุฃุดูุงู
  };
</script>

</body>
</html>
